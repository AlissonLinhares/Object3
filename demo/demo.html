<html>
	<head>
		<meta http-equiv="content-type" content="text/html; charset=utf-8">
		<title>Oxygen</title>

		<!-- <script type="text/javascript" src="demo&#45;min.js"></script> -->
		<script type="text/javascript" src="../world/grid.js"></script>
		<script type="text/javascript" src="../world/world.js"></script>
		<script type="text/javascript" src="../world/objects/object3d.js"></script>
		<script type="text/javascript" src="../world/objects/shapes/shape.js"></script>
		<script type="text/javascript" src="../world/objects/shapes/plane.js"></script>
		<script type="text/javascript" src="../world/objects/shapes/cube.js"></script>
		<script type="text/javascript" src="../world/objects/shapes/pyramid.js"></script>
		<script type="text/javascript" src="../world/objects/shapes/face.js"></script>
		<script type="text/javascript" src="../world/objects/tile.js"></script>
		<script type="text/javascript" src="../world/objects/camera.js"></script>
		<script type="text/javascript" src="../world/objects/terrain.js"></script>
		<script type="text/javascript" src="../world/effects/particle.js"></script>
		<script type="text/javascript" src="../world/effects/effect.js"></script>
		<script type="text/javascript" src="../world/effects/fire.js"></script>
		<script type="text/javascript" src="../timer.js"></script>
		<script type="text/javascript" src="../oxygen.js"></script>
		<script type="text/javascript" src="../utils/avltree.js"></script>
		<script type="text/javascript" src="../render/canvas.js"></script>
		<script type="text/javascript" src="../render/render.js"></script>
		<script type="text/javascript" src="../render/pool.js"></script>
		<script type="text/javascript" src="../input/mouse.js"></script>
		<script type="text/javascript" src="../input/keyboard.js"></script>
		<script type="text/javascript" src="../input/touch.js"></script>
		<script type="text/javascript" src="../media/animation.js"></script>
		<script type="text/javascript" src="../media/sound.js"></script>
		<script type="text/javascript" src="../media/texture.js"></script>
		<script type="text/javascript" src="../media/resources.js"></script>
		<script type="text/javascript" src="../media/tileset.js"></script>
		<script type="text/javascript" src="swordsman.js"></script>
		<!-- <script type="text/javascript" src="level.js"></script> -->
	</head>

	<body>
		<font color="white">
			FPS: <label name="fps" id="fps">23.630000000000003</label><br>
			ARMY: <label name="army" id="army">100</label><br>
			PLAYER: left/right/up/down<br>
			CAMERA: w/s/a/d <br>
			ZOOM: i/o (Experimental) <br>
			PROJECTION: e/q (Experimental) <br>
			ADD SOLDIERS: m <br>
			REMOVE SOLDIERS: n <br>
		</font>

		<script type="text/javascript">
			function getUrlVars() {
				var vars = {};

				var parts = window.location.href.replace(/[?&]+([^=&]+)=([^&]*)/gi, function(m,key,value) {
					vars[key] = value;
				});

				return vars;
			}

			total = getUrlVars()["total"] | 5;

			var Demo = function () {
				Oxygen.call( this );

				this.player = new Swordsman( 2, 2.0, 2 );
				this.add( this.player );

				for ( var i = 0; i < total; i++ ) {
					for ( var j = 0; j < total; j++ ) {
						var soldier = new Swordsman( i - 10, 0, j );
						this.army.push( soldier );
						this.add( soldier );
					}
				}

				document.getElementById('army').innerHTML = total * total;
			}

			Demo.prototype = Object.create( Oxygen.prototype );
			Demo.prototype.army    = [];
			Demo.prototype.player  = [];

			/** @override */
			Demo.prototype.onStart = function() {

			}

			/** @override */
			Demo.prototype.onKeyDown = function() {
				var camera = this.getCamera();
				var world = this.getWorld();

				if ( Keyboard.isDown( KEY_R ) ) {
					world.turnRight();
					camera.rotateY( Math.PI / 2 );
				} else if ( Keyboard.isDown( KEY_L ) ) {
					world.turnLeft();
					camera.rotateY( -Math.PI / 2  );
				}

				if ( Keyboard.isDown( KEY_I ) ) {
					camera.zoom( 0.1 );
				} else if ( Keyboard.isDown( KEY_O ) ) {
					camera.zoom(-0.1 );
				}

				if ( Keyboard.isDown( KEY_Q ) ) {
					camera.scaleX( 0.01 );
				} else if ( Keyboard.isDown( KEY_E ) ) {
					camera.scaleX( -0.01 );
				}
			}

			/** @override */
			Demo.prototype.onKeyUp = function() {
				var ptr = this.onKeyUp;
				this.onKeyUp = function(){}

				if ( Keyboard.isUp( KEY_M ) ) {
					total++;

					window.location.href="demo.html?total="+total;
				} else if ( Keyboard.isUp( KEY_N ) ) {
					total--;

					if ( total <= 0 )
						total = 0;

					window.location.href="demo.html?total="+total;
				}

				this.onKeyUp = ptr;
			}

			Demo.prototype.updateAllSoldiers = function() {
				var frame = Timer.now / 50;
				var speed = 0.05 * Timer.elapsed;

				var x = Math.sin( frame ) > 0 ? speed : -speed;
				var z = Math.cos( frame ) > 0 ? speed : -speed;

				for ( var i = 0, len = this.army.length; i < len; i++ )
					this.army[i].walk( x, z );
			}

			/** @override */
			Demo.prototype.onMouseDown = function() {
				this.player.onMouseDown();
			}

			/** @override */
			Demo.prototype.onTouchStart = function( event ) {
				Demo._x = event.targetTouches[0].pageX;
				Demo._y = event.targetTouches[0].pageY;
			}

			/** @override */
			Demo.prototype.onTouchMove = function( event ) {
				var camera = this.getCamera();
				var x = event.targetTouches[0].pageX;
				var y = event.targetTouches[0].pageY;

				camera.forward( (y - Demo._y) / 50 );
				camera.left( (x - Demo._x) / 50 );

				Demo._x = x;
				Demo._y = y;
			}

			/** @override */
			Demo.prototype.onUpdate = function() {
				var camera = this.getCamera();

				if ( Keyboard.isDown( KEY_W ) ) {
					camera.forward( 0.5 * Timer.elapsed );
				} else if ( Keyboard.isDown( KEY_S ) ) {
					camera.backward( 0.5 * Timer.elapsed );
				}

				if ( Keyboard.isDown( KEY_A ) ) {
					camera.left( 0.5 * Timer.elapsed );
				} else if ( Keyboard.isDown( KEY_D ) ) {
					camera.right( 0.5 * Timer.elapsed );
				}

				this.player.onUpdate();
				this.updateAllSoldiers();
				document.getElementById('fps').innerHTML = this.getFPS();
			}

			var demo = new Demo();
			demo.start();
		</script>
	</body>
</html>
